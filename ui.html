<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Shortcuts</title>
  <style>
    @font-face {
      font-family: 'Roboto Mono';
      src: url('https://static.figma.com/font/RobotoMono_wght__1') format('truetype');
      font-weight: 400;
      font-style: normal;
    }

    :root {
      --figma-color-bg: #ffffff;
      --figma-color-bg-secondary: #f5f5f5;
      --figma-color-bg-elevated: #ffffff;
      --figma-color-bg-hover: #f5f5f5;
      --figma-color-bg-pressed: #f5f5f5;
      --figma-color-bg-brand: #0d99ff;
      --figma-color-text: #000000E5;
      --figma-color-text-secondary: #00000080;
      --figma-color-text-tertiary: #b3b3b3;
      --figma-color-text-onbrand: #ffffff;
      --figma-color-text-tooltip: #ffffff;
      --figma-color-border: #e6e6e6;
      --figma-color-border-strong: #2c2c2c;
      --figma-color-border-translucent: #0000001a;
      --figma-color-border-success: #aff4c6;
      --figma-color-border-warning: #ffe8a3;
      --figma-color-border-warning-strong: #ffcd29;
      --figma-color-border-brand: #bde3ff;
      --figma-color-icon: #000000E5;
      --figma-color-icon-secondary: #b3b3b3;
      --figma-color-icon-tertiary: #d9d9d9;
      --figma-color-icon-onbrand: #ffffff;
      --figma-color-success: #14ae5c;
      --figma-color-warning: #f24822;
      --figma-color-bg-brand-hover: #007be5;
      --figma-color-bg-brand-pressed: #007be5;
      --figma-color-bg-brand-secondary: #0768cf;
      --figma-color-bg-brand-tertiary: #e5f4ff;
      --figma-color-bg-selected-secondary: #f2f9ff;
      --figma-color-bg-success-secondary: #008043;
      --figma-color-bg-success-tertiary: #d5f7da;
      --figma-color-bg-warning-secondary: #eba611;
      --figma-color-bg-warning-tertiary: #fff1c2;
      --figma-color-bg-tertiary: #e6e6e6;
      --figma-color-bg-tooltip: #1e1e1e;
      --figma-color-bg-menu: #1e1e1e;
      --figma-font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --figma-font-family-mono: 'Roboto Mono', 'Monaco', 'Courier New', monospace;
      --figma-elevation-300-tooltip: 0px 0px .5px rgba(0, 0, 0, .15), 0px 5px 12px rgba(0, 0, 0, .13), 0px 1px 3px rgba(0, 0, 0, .1);
      --figma-elevation-400-menu-panel: 0px 0px .5px rgba(0, 0, 0, .12), 0px 10px 16px rgba(0, 0, 0, .12), 0px 2px 5px rgba(0, 0, 0, .15);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: var(--figma-font-family);
      font-size: 11px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg);
      margin: 0;
      padding: 0;
      user-select: none;
    }

    h2 {
      font-size: 15px;
      font-weight: 550;
      line-height: 25px;
      margin: 0;
    }

    p {
      margin: 0;
      font-size: 11px;
    }

    button {
      font-family: var(--figma-font-family);
    }

    .container {
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ========== 重构后的 Status Bar 样式 ========== */
    .status-bar-container {
      padding: 0;
    }

    .status-bar-container.hidden {
      display: none;
    }

    .status-bar {
      padding: 12px;
      height: 120px;
      background: var(--figma-color-bg-elevated);
      border: 0.5px solid var(--figma-color-border);
      box-shadow: 0 0.5px 0 0.5px var(--figma-color-border);
      text-align: center;
      font-size: 14px;
      line-height: 120%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 8px;
      transition: all 0.15s ease;
    }

    /* Status Bar States */
    .status-bar.wait-action {
      background: var(--figma-color-bg-success-tertiary);
      color: var(--figma-color-bg-success-secondary);
      border: 0.5px solid var(--figma-color-border-success);
    }

    .status-bar.listening-set {
      background: var(--figma-color-bg-brand-tertiary);
      color: var(--figma-color-bg-brand-secondary);
      border: 0.5px solid var(--figma-color-border-brand);
    }

    /* Floating Status Bar for Config Page */
    .status-bar.float {
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      padding: 0 16px;
      border-radius: 5px;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 2px 6px 0 rgba(0, 0, 0, 0.05);
      z-index: 1000;
      height: 84px;
    }

    .status-bar-title {
      font-size: 18px;
      font-weight: 550;
      line-height: 120%;
      margin: 0;
    }

    .status-bar-description {
      font-size: 11px;
      margin: 0;
    }

    .dots-animation {
      display: inline-block;
      width: 18px;
      text-align: left;
    }

   .dots-animation::after {
      content: "...";
      animation: dotsContent 1s infinite;
    }

    @keyframes dotsContent {
      0% {
        content: ".";
      }

      33% {
        content: "..";
      }

      66% {
        content: "...";
      }

      100% {
        content: ".";
      }
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px 16px;
      min-height: 0;
    }

    .card {
      background: var(--figma-color-bg-elevated);
      border: 1px solid var(--figma-color-border);
      border-radius: 5px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .card:last-child {
      margin-bottom: 0;
    }

    .page {
      display: none;
    }

    .page.active {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 0;
    }

    /* 主页面特殊布局 */
    #mainPage {
      flex: 1;
      min-height: 0;
    }

    #mainPage .content {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .section-title {
      font-size: 11px;
      font-weight: 550;
      line-height: 16px;
      margin: 0;
    }

    .category-title {
      font-size: 11px;
      font-weight: 550;
      line-height: 16px;
      margin: 0;
      color: var(--figma-color-text);
      position: sticky;
      top: 0;
      background-color: var(--figma-color-bg);
      padding: 8px 0 4px;
      z-index: 10;
    }

    .category-title:first-child {
      margin-top: 0;
    }

    .shortcuts-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .shortcuts-list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .iconBtnSmall {
      background: none;
      border: none;
      padding: 0;
      border-radius: 5px;
      transition: background-color 0.2s ease;
    }

    .iconBtnSmall:hover {
      background: var(--figma-color-bg-hover);
    }

    .iconBtnSmall svg,
    .iconBtnSmall svg * {
      pointer-events: none;
    }

    /* ==========  Shortcut Card  ========== */
    .shortcut-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 6px 6px 10px;
      background: var(--figma-color-bg);
      border: 1px solid var(--figma-color-border-translucent);
      border-radius: 5px;
      font-size: 11px;
      line-height: 130%;
      transition: background-color 0.15s ease;
      gap: 4px;
      position: relative;
      transition: all 0.15s ease;
    }

    .shortcut-card .shortcut-name {
      padding: 2px 0;
      color: var(--figma-color-text);
      font-weight: 500;
      word-break: break-word;
    }

    /* Custom action indicator */
    .shortcut-card.custom-action:before {
      content: '';
      display: flex;
      align-items: center;
      justify-content: center;
      width: 2px;
      height: 16px;
      background-color: var(--figma-color-bg-brand);
      border-radius: 2px;
      position: absolute;
      left: 0px;
      transform: translate(-50%, 0);
    }

    .shortcut-card.clickable:hover {
      background-color: var(--figma-color-bg-hover);
    }

    .shortcut-card.clickable:hover .key-text, .shortcut-card.clickable:hover .action-button {
      background-color: var(--figma-color-text-onbrand);
    }

    /* Conflict indicator */
    .shortcut-card.conflict {
      border: 1px solid var(--figma-color-border-warning-strong);
    }

    /* ==========  Set Shortcut Button 样式 ========== */
    .shortcut-button {
      display: flex;
      align-items: center;
      gap: 2px;
      background: none;
      border: none;
      padding: 0;
      font-size: 11px;
      min-height: 24px;
      position: relative;
      pointer-events: auto;
    }

    .shortcut-button.disabled {
      pointer-events: none;
    }

    /* Set Shortcut Action Button */
    .shortcut-button .action-button {
      background: var(--figma-color-bg-secondary);
      padding: 4px 8px;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 450;
      color: var(--figma-color-text-secondary);
      min-width: 80px;
      text-align: center;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .shortcut-button .action-button.listening {
      background: var(--figma-color-bg-brand) !important;
      color: var(--figma-color-text-onbrand) !important;
    }

    /* Key Display */
    .shortcut-button .key-display {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .shortcut-button .key-text {
      background: var(--figma-color-bg-secondary);
      padding: 4px 8px;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 450;
      color: var(--figma-color-text);
      min-width: 16px;
      text-align: center;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 24px;
      min-width: 24px;
    }

    .shortcut-button .key-text.listening {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
    }

    /* Button States */
    .shortcut-button.state-empty .action-button {
      display: flex;
    }

    .shortcut-button.state-empty .key-display {
      display: none;
    }

    .shortcut-button.state-set .action-button {
      display: none;
    }

    .shortcut-button.state-set .key-display {
      display: flex;
    }

    .shortcut-button.state-listening .action-button {
      display: flex;
    }

    .shortcut-button.state-listening .key-display {
      display: none;
    }

    .footer {
      padding: 8px 12px;
      border-top: 1px solid var(--figma-color-border);
    }

    .button {
      padding: 0 12px;
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      border: none;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 550;
      transition: all 0.1s ease;
      height: 32px;
      font-family: var(--figma-font-family);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .button:active {
      background: var(--figma-color-bg-brand-pressed);
    }

    .button.secondary {
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
    }

    .button.plain {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text-secondary);
      border: none;
      font-weight: 450;
      height: 24px;
      padding: 4px 8px;
    }

    .button.warning {
      background: var(--figma-color-warning);
      color: var(--figma-color-text-onbrand);
    }

    .button.warning:hover {
      background: var(--figma-color-bg-warning-secondary);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid var(--figma-color-border);
      position: relative;
    }

    .header h2 {
      margin: 0;
      color: var(--figma-color-text);
      text-align: center;
      flex: 1;
    }

    .back-button {
      position: absolute;
      border: none;
      padding: 4px;
      color: var(--figma-color-icon);
      width: 28px;
      height: 28px;
      border-radius: 5px;
      transition: opacity 0.2s ease;
      transition: all 0.2s ease;
      background-color: var(--figma-color-bg);
    }

    .back-button:hover {
      opacity: 1;
      background-color: var(--figma-color-bg-hover);
    }

    .tabs-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      height: 40px;
      border-bottom: 1px solid var(--figma-color-border);
    }

    .tabs {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .tab {
      padding: 0 8px;
      height: 24px;
      background: var(--figma-color-bg);
      border: none;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 450;
      color: var(--figma-color-text-secondary);
      transition: all 0.1s ease;
    }

    .tab.active {
      color: var(--figma-color-text);
      background: var(--figma-color-bg-secondary);
      font-weight: 550;
    }

    .tab:hover {
      background: var(--figma-color-bg-hover);
    }

    .config-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 4px 16px 16px;
    }

    .tab-content {
      display: none;
      padding: 0;
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .tab-content.active {
      display: block;
    }

    #configPage .content {
      flex: 1;
      padding: 0px;
      background-color: var(--figma-color-bg);
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    #addCustomPage .content {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .config-item {
      margin-bottom: 4px;
    }

    .config-item:last-child {
      margin-bottom: 0;
    }

    .add-custom-action-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 16px auto 8px;
    }

    .add-button {
      width: auto;
      padding: 8px 12px;
      background-color: var(--figma-color-bg);
      border: 1px solid var(--figma-color-border-translucent);
      border-radius: 5px;
      font-size: 11px;
      color: var(--figma-color-text);
      transition: all 0.1s ease;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-size: 11px;
      color: var(--figma-color-text);
      font-weight: 500;
    }

    .form-input {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 5px;
      font-size: 11px;
      font-family: var(--figma-font-family);
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--figma-color-bg-brand);
    }

    .form-textarea {
      min-height: 140px;
      resize: vertical;
    }

    .form-textarea.code-editor {
      list-style: 18px;
      font-family: var(--figma-font-family-mono);
      font-size: 11px;
    }

    .form-actions {
      display: flex;
      gap: 8px;
    }

    .form-actions .button {
      flex: 1;
      padding: 0;
    }

    .form-actions .button.more-actions {
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      max-width: 24px;
      border-radius: 0px 5px 5px 0px;
      border: none;
      transition: all 0.1s ease;
    }

    .form-actions .button.more-actions.active {
      background: var(--figma-color-bg-selected-secondary);
      color: var(--figma-color-bg-brand);
    }

    #customShortcutBtn {
      width: fit-content;
    }

    .more-action-button-group {
      display: flex;
      gap: 1px;
      flex: 1;
      position: relative;
    }

    .more-action-button-group .button#saveCustomBtnGroup {
      border-radius: 5px 0px 0px 5px;
    }

    .empty-state {
      text-align: center;
      padding: 24px;
      color: var(--figma-color-text-secondary);
      font-size: 11px;
    }

    .tabs-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease;
      width: 100%;
    }

    .search-content {
      display: none;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      transition: all 0.2s ease;
    }

    .search-content.active {
      display: flex;
    }

    .search-input-container {
      position: relative;
      flex: 1;
      margin-right: 8px;
    }

    .search-input {
      width: 100%;
      height: 24px;
      padding: 8px 8px 8px 24px;
      background: var(--figma-color-bg-secondary);
      border: none;
      border-radius: 5px;
      font-size: 11px;
      font-family: var(--figma-font-family);
      color: var(--figma-color-text);
      transition: all 0.2s ease;
    }

    .search-input:focus {
      outline: 1px solid var(--figma-color-bg-brand);
      background: var(--figma-color-bg);
    }

    .search-input::placeholder {
      color: var(--figma-color-text-secondary);
    }

    .search-icon {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }

    .search-icon svg {
      width: 24px;
      height: 24px;
    }

    .close-search-btn {
      background: none;
      border: none;
      padding: 0;
      border-radius: 5px;
      transition: background-color 0.2s ease;
    }

    .close-search-btn:hover {
      background: var(--figma-color-bg-hover);
    }

    .close-search-btn svg {
      width: 24px;
      height: 24px;
    }

    .footer-info-container {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 6px;
      z-index: 1000;
      pointer-events: none;
    }

    .footer-info-container.hidden {
      display: none;
    }

    .footer-info {
      padding: 8px;
      font-size: 11px;
      color: var(--figma-color-bg-brand);
      font-weight: 450;
      background: color-mix(in srgb, var(--figma-color-bg-brand-tertiary), transparent 60%);
      border: 0.5px solid var(--figma-color-border-brand);
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      border-radius: 99999px;
      text-align: center;
    }

    #focusable {
      position: absolute;
      top: -1000px;
      left: -1000px;
      opacity: 0;
      width: 1px;
      height: 1px;
    }

    .dropdown-menu {
      position: absolute;
      bottom: 40px;
      right: 0;
      background: #1e1e1e;
      border-radius: 13px;
      padding: 8px;
      box-shadow: var(--figma-elevation-400-menu-panel);
      min-width: 140px;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .dropdown-menu .dropdown-item {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 5px;
      min-height: 24px;
      display: flex;
      align-items: center;
      justify-content: start;
      word-break: break-word;
      color: var(--figma-color-text-onbrand);
      text-align: left;
    }

    .dropdown-menu .dropdown-item:hover {
      background: var(--figma-color-bg-brand);
    }

    /* Tooltip styles */
    .tooltip {
      position: absolute;
      background: var(--figma-color-bg-tooltip);
      color: var(--figma-color-text-tooltip);
      border: 1px solid var(--figma-color-border);
      border-radius: 11px;
      padding: 12px;
      font-size: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      width: calc(100% - 24px);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.1s ease;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 4px;
      height: fit-content;
      line-height: 150%;
      text-align: center;
      font-weight: 450;
    }

    .tooltip.show {
      opacity: 1;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="status-bar-container" id="statusBarContainer">
      <div class="status-bar wait-action" id="statusBar">
        <p class="status-bar-title">Capturing Keys<span class="dots-animation"></span></p>
        <p class="status-bar-description">Press shortcuts to run actions • ⌘+Click to configure</p>
      </div>
    </div>
    <div class="footer-info-container hidden">
      <div class="footer-info" id="footerInfo">
        <p>⌘+Click to set shortcut</p>
      </div>
    </div>
    <!-- Main page -->
    <div class="page active" id="mainPage">
      <div class="content">
        <div class="shortcuts-list" id="shortcutsList">
          <div class="empty-state">
            <h2>No shortcuts configured yet</h2>
            <button class="button" id="configureBtn" style="margin-top: 16px;">Configure Shortcuts</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Configuration page -->
    <div class="page" id="configPage">
      <div class="header">
        <button class="back-button" id="backBtn"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
            viewBox="0 0 24 24">
            <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M20 12H4m0 0l6-6m-6 6l6 6" />
          </svg></button>
        <h2>Configure Shortcuts</h2>
        <div></div>
      </div>

      <div class="tabs-container">
        <div class="tabs-content">
          <div class="tabs">
            <button class="tab active" data-tab="default">Base Actions</button>
            <button class="tab" data-tab="custom">Custom Actions</button>
          </div>
          <button class="iconBtnSmall" id="searchBtn">
            <svg width="24" height="24" fill="none" viewBox="0 0 24 24">
              <path fill="var(--figma-color-icon)" fill-rule="evenodd"
                d="M16 11.5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0m-.956 4.206a5.5 5.5 0 1 1 .662-.662.5.5 0 0 1 .148.102l3 3a.5.5 0 1 1-.707.707l-3-3a.5.5 0 0 1-.103-.147"
                clip-rule="evenodd">
              </path>
            </svg>
          </button>
        </div>
        <div class="search-content">
          <div class="search-input-container">
            <div class="search-icon">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24">
                <path fill="var(--figma-color-icon)" fill-rule="evenodd"
                  d="M16 11.5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0m-.956 4.206a5.5 5.5 0 1 1 .662-.662.5.5 0 0 1 .148.102l3 3a.5.5 0 1 1-.707.707l-3-3a.5.5 0 0 1-.103-.147"
                  clip-rule="evenodd">
                </path>
              </svg>
            </div>
            <input type="text" class="search-input" id="searchInput" placeholder="Find..." />
          </div>
          <button class="close-search-btn" id="closeSearchBtn">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24">
              <path fill="var(--figma-color-icon)" fill-rule="evenodd"
                d="M17.354 6.646a.5.5 0 0 1 0 .708L12.707 12l4.647 4.646a.5.5 0 0 1-.708.708L12 12.707l-4.646 4.647a.5.5 0 0 1-.708-.708L11.293 12 6.646 7.354a.5.5 0 0 1 .708-.707L12 11.293l4.646-4.647a.5.5 0 0 1 .708 0"
                clip-rule="evenodd"></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="content">
        <!-- Default actions tab -->
        <div class="tab-content active" id="defaultTab">
          <div class="config-list" id="defaultConfigList">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- Custom actions tab -->
        <div class="tab-content" id="customTab">
          <div class="add-custom-action-container">
            <button class="add-button" id="addCustomBtn">Add Custom Action</button>
          </div>
          <div class="config-list" id="customConfigList">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- Add custom action page -->
    <div class="page" id="addCustomPage">
      <div class="header">
        <button class="back-button" id="backToConfigBtn"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
            viewBox="0 0 24 24">
            <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M20 12H4m0 0l6-6m-6 6l6 6" />
          </svg></button>
        <h2>Add Custom Action</h2>
        <div></div>
      </div>

      <div class="content">
        <div class="form-group">
          <label class="form-label">Name</label>
          <input type="text" class="form-input" id="customActionName" placeholder="Enter action name">
        </div>

        <div class="form-group">
          <label class="form-label">Function</label>
          <textarea class="form-input form-textarea code-editor" id="customActionFunction"
            placeholder="// Example:&#10;&#10;selection.forEach(node => {&#10;  if ('cornerRadius' in node) {&#10;    node.cornerRadius = 8;&#10;  }&#10;});"></textarea>
          <button class="button plain" id="testRunBtn" style="margin-top: 8px;">Test Run</button>
        </div>

        <div class="form-group">
          <label class="form-label">Shortcut</label>
          <div id="customShortcutBtn"></div>
        </div>

        <div class="form-actions">
          <button class="button secondary" id="cancelCustomBtn">Cancel</button>
          <button class="button" id="saveCustomBtn">Save</button>
          <div class="more-action-button-group" style="display: none;">
            <button class="button" id="saveCustomBtnGroup">Save</button>
            <button class="button more-actions" id="moreActionsBtn" type="button"><svg width="16" height="16"
                fill="none" viewBox="0 0 16 16">
                <path fill="currentColor" fill-rule="evenodd"
                  d="M10.475 6.768a.5.5 0 0 1 0 .707L8.354 9.596 8 9.95l-.354-.354-2.12-2.121a.5.5 0 0 1 .706-.707L8 8.536l1.768-1.768a.5.5 0 0 1 .707 0"
                  clip-rule="evenodd"></path>
              </svg></button>
            <div id="moreActionsDropdown" class="dropdown-menu" style="display:none;">
              <div class="dropdown-item" id="duplicateCustomBtn">Duplicate</div>
              <div class="dropdown-item" id="deleteCustomBtn">Delete</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden input for capturing keyboard events -->
    <input type="text" id="focusable" tabindex="0">
  </div>

  <script>
    // ========== 重构后的全局状态 ==========
    let currentPage = 'main';
    let currentTab = 'default';
    let shortcuts = {};
    let customActions = [];
    let defaultActions = {};
    let isListening = false;
    let listeningActionId = null;
    let platform = 'mac';
    let pressedCodes = new Set(); // 累积显示的按键
    let currentlyPressed = new Set(); // 当前物理按下的按键
    let currentEditingActionId = null;
    let ignoreFirstKeyUp = false;
    let delayTimer = null;
    let shortcutSaved = false; // 是否已保存快捷键
    let tempShortcuts = {}; // 临时快捷键存储

    // DOM elements
    const statusBarContainer = document.getElementById('statusBarContainer');
    const statusBar = document.getElementById('statusBar');
    const focusable = document.getElementById('focusable');
    const shortcutsList = document.getElementById('shortcutsList');
    const backBtn = document.getElementById('backBtn');
    const backToConfigBtn = document.getElementById('backToConfigBtn');
    const addCustomBtn = document.getElementById('addCustomBtn');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const pages = document.querySelectorAll('.page');

    // ========== 1. Code 到 Key 显示映射函数 ==========
    const codeToKeyMap = {
      // Numbers
      'Digit0': '0', 'Digit1': '1', 'Digit2': '2', 'Digit3': '3', 'Digit4': '4',
      'Digit5': '5', 'Digit6': '6', 'Digit7': '7', 'Digit8': '8', 'Digit9': '9',
      // Letters
      'KeyA': 'A', 'KeyB': 'B', 'KeyC': 'C', 'KeyD': 'D', 'KeyE': 'E', 'KeyF': 'F',
      'KeyG': 'G', 'KeyH': 'H', 'KeyI': 'I', 'KeyJ': 'J', 'KeyK': 'K', 'KeyL': 'L',
      'KeyM': 'M', 'KeyN': 'N', 'KeyO': 'O', 'KeyP': 'P', 'KeyQ': 'Q', 'KeyR': 'R',
      'KeyS': 'S', 'KeyT': 'T', 'KeyU': 'U', 'KeyV': 'V', 'KeyW': 'W', 'KeyX': 'X',
      'KeyY': 'Y', 'KeyZ': 'Z',
      // Special characters
      'Minus': '-', 'Equal': '=', 'BracketLeft': '[', 'BracketRight': ']',
      'Backslash': '\\', 'Semicolon': ';', 'Quote': '\'', 'Comma': ',', 'Period': '.', 'Slash': '/',
      'Backquote': '`',
      // Numpad
      'Numpad0': 'Num0', 'Numpad1': 'Num1', 'Numpad2': 'Num2', 'Numpad3': 'Num3', 'Numpad4': 'Num4',
      'Numpad5': 'Num5', 'Numpad6': 'Num6', 'Numpad7': 'Num7', 'Numpad8': 'Num8', 'Numpad9': 'Num9',
      'NumpadAdd': '+', 'NumpadSubtract': '-', 'NumpadMultiply': '*', 'NumpadDivide': '/',
      'NumpadDecimal': '.',
      // Function keys
      'Space': 'Space', 'Tab': 'Tab', 'Enter': 'Enter', 'Backspace': 'Backspace',
      'Escape': 'Esc',
      // Arrow keys
      'ArrowUp': '↑', 'ArrowDown': '↓', 'ArrowLeft': '←', 'ArrowRight': '→',
      // Other keys
      'CapsLock': 'Caps', 'ContextMenu': 'Menu',
      'Insert': 'Ins', 'Delete': 'Del', 'Home': 'Home', 'End': 'End', 'PageUp': 'PgUp', 'PageDown': 'PgDn',
    };

    /**
     * 将 code 转换为用户友好的显示字符
     * @param {string} code - 键盘事件的 code
     * @returns {string} 用户友好的显示字符
     */
    function codeToDisplayKey(code) {
      // 修饰键处理
      if (code === 'cmd' || code === 'command') return '⌘';
      if (code === 'ctrl' || code === 'control') return platform === 'mac' ? '⌃' : 'Ctrl';
      if (code === 'alt' || code === 'option') return platform === 'mac' ? '⌥' : 'Alt';
      if (code === 'shift') return '⇧';
      if (code === 'win' || code === 'windows') return '⊞';
      if (code === 'fn' || code === 'function') return platform === 'mac' ? 'fn' : 'Fn';
      if (code === 'capslock' || code === 'caps') return '⇪';

      // 使用映射表
      return codeToKeyMap[code] || code.toUpperCase();
    }

    // ========== 2. 统一的 Shortcut Card 组件 ==========
    /**
     * 创建快捷键卡片组件
     * @param {Object} options - 配置选项
     * @param {string} options.actionId - 动作 ID
     * @param {string} options.actionName - 动作名称
     * @param {string} options.shortcut - 快捷键字符串
     * @param {boolean} options.isCustomAction - 是否为自定义动作
     * @param {boolean} options.hasConflict - 是否有冲突
     * @param {string} options.tooltipText - 提示文本
     * @param {Function} options.onCardClick - 卡片点击回调
     * @param {boolean} options.allowCommandClick - 是否允许命令点击
     * @param {boolean} options.allowSetShortcut - 是否允许设置快捷键
     * @returns {string} HTML 字符串
     */
    function createShortcutCard(options) {
      const {
        actionId,
        actionName,
        shortcut,
        isCustomAction = false,
        hasConflict = false,
        tooltipText = '',
        onCardClick = null,
        allowCommandClick = false,
        allowSetShortcut = false
      } = options;

      const cardClasses = [
        'shortcut-card',
        isCustomAction ? 'custom-action' : '',
        hasConflict ? 'conflict' : '',
        onCardClick ? 'clickable' : ''
      ].filter(Boolean).join(' ');

      const tooltipAttr = tooltipText ? ` data-tooltip="${tooltipText}"` : '';

      return `
        <div class="${cardClasses}" data-action="${actionId}"${tooltipAttr}>
          <div class="shortcut-name">${actionName}</div>
          ${createSetShortcutButton({ actionId, shortcut, allowSetShortcut })}
        </div>
      `;
    }

    /**
     * 获取快捷键（从正式存储或临时存储）
     * @param {string} actionId - 动作 ID
     * @returns {string} 快捷键字符串
     */
    function getShortcut(actionId) {
      return tempShortcuts[actionId] || shortcuts[actionId] || '';
    }

    /**
     * 创建设置快捷键按钮组件
     * @param {Object} options - 配置选项
     * @param {string} options.actionId - 动作 ID
     * @param {string} options.shortcut - 快捷键字符串
     * @param {boolean} options.allowSetShortcut - 是否允许设置快捷键
     * @returns {string} HTML 字符串
     */
    function createSetShortcutButton(options) {
      const { actionId, shortcut, allowSetShortcut } = options;

      const hasShortcut = shortcut && shortcut.length > 0;
      const state = hasShortcut ? 'state-set' : 'state-empty';
      // 始终可点击，通过 CSS pointer-events 控制

      return `
        <div class="shortcut-button ${state} clickable ${allowSetShortcut ? '' : 'disabled'}" data-action="${actionId}">
          <div class="action-button">Set Shortcut</div>
          <div class="key-display">${hasShortcut ? renderShortcutKeys(shortcut) : ''}</div>
        </div>
      `;
    }

    /**
     * 渲染快捷键显示
     * @param {string} shortcut - 快捷键字符串
     * @returns {string} HTML 字符串
     */
    function renderShortcutKeys(shortcut) {
      if (!shortcut) return '';

      const keys = shortcut.split('+');
      return keys.map(key => `<span class="key-text">${codeToDisplayKey(key)}</span>`).join('');
    }

    // ========== 3. 统一的 Status Bar 组件 ==========
    /**
     * 更新状态栏
     * @param {string} state - 状态 ('wait-action' | 'listening-set')
     * @param {string} title - 标题
     * @param {string} description - 描述
     * @param {boolean} isFloat - 是否为浮动样式
     */
    function updateStatusBar(state, title, description, isFloat = false) {
      const statusBarEl = statusBar;
      const titleEl = statusBarEl.querySelector('.status-bar-title');
      const descEl = statusBarEl.querySelector('.status-bar-description');

      // 更新状态类
      statusBarEl.className = `status-bar ${state}${isFloat ? ' float' : ''}`;

      // 更新内容
      titleEl.innerHTML = title;
      descEl.textContent = description;
    }

    // ========== 4. Set Shortcut 函数 ==========
    /**
     * 开始设置快捷键
     * @param {string} actionId - 动作 ID
     * @param {boolean} commandTriggered - 是否由命令点击触发
     */
    function startSetShortcut(actionId, commandTriggered = false) {
      if (isListening) return;

      isListening = true;
      listeningActionId = actionId;
      ignoreFirstKeyUp = commandTriggered;
      shortcutSaved = false; // 初始化保存状态
      pressedCodes.clear();
      currentlyPressed.clear();

      // 更新按钮状态
      const button = document.querySelector(`[data-action="${actionId}"] .shortcut-button`);
      if (button) {
        button.className = 'shortcut-button state-listening clickable';
        const actionBtn = button.querySelector('.action-button');
        if (actionBtn) {
          actionBtn.textContent = 'Press keys...';
          actionBtn.classList.add('listening');
        }
      }

      // 特别处理自定义动作页面中的快捷键按钮
      if (currentPage === 'addCustom') {
        const customShortcutButton = document.querySelector('#customShortcutBtn .shortcut-button');
        if (customShortcutButton && customShortcutButton.dataset.action === actionId) {
          customShortcutButton.className = 'shortcut-button state-listening clickable';
          const actionBtn = customShortcutButton.querySelector('.action-button');
          if (actionBtn) {
            actionBtn.textContent = 'Press keys...';
            actionBtn.classList.add('listening');
          }
        }
      }

      // 更新状态栏
      const actionName = getActionName(actionId);
      const isFloat = currentPage === 'config' || currentPage === 'addCustom';
      updateStatusBar('listening-set', `Press keys to set shortcut<span class="dots-animation"></span>`, 'ESC to cancel • DELETE to remove', isFloat);

      // 在配置页面和自定义页面显示浮动状态栏
      if (currentPage === 'config' || currentPage === 'addCustom') {
        statusBarContainer.classList.remove('hidden');
        statusBar.classList.add('float');
      }

      focusable.focus();
    }

    /**
     * 停止设置快捷键
     */
    function stopSetShortcut() {
      if (!isListening) return;

      isListening = false;
      const actionId = listeningActionId;
      listeningActionId = null;
      ignoreFirstKeyUp = false;
      shortcutSaved = false; // 重置保存状态
      pressedCodes.clear(); // 清空累积的按键
      currentlyPressed.clear(); // 清空当前按下的按键

      if (delayTimer) {
        clearTimeout(delayTimer);
        delayTimer = null;
      }

      // 恢复按钮状态
      updateShortcutButton(actionId);

      // 恢复状态栏
      if (currentPage === 'main') {
        updateStatusBar('wait-action', 'Capturing Keys<span class="dots-animation"></span>', 'Press shortcuts to run actions • ⌘+Click to configure');
      } else if (currentPage === 'config' || currentPage === 'addCustom') {
        statusBarContainer.classList.add('hidden');
        statusBar.classList.remove('float');
      }
    }

    // ========== 辅助函数 ==========
    /**
     * 获取动作名称
     */
    function getActionName(actionId) {
      // 搜索默认动作
      for (const category in defaultActions) {
        if (defaultActions[category][actionId]) {
          return defaultActions[category][actionId];
        }
      }

      // 搜索自定义动作
      const customAction = customActions.find(a => a.id === actionId);
      if (customAction) {
        return customAction.name;
      }

      return actionId;
    }

    /**
     * 检查是否为自定义动作
     */
    function isCustomAction(actionId) {
      return actionId.startsWith('custom_');
    }

    /**
     * 检测快捷键冲突
     */
    function detectShortcutConflicts() {
      const conflicts = {};
      const shortcutToActions = {};

      // 构建快捷键到动作的映射
      for (const [action, shortcut] of Object.entries(shortcuts)) {
        if (shortcut) {
          if (!shortcutToActions[shortcut]) {
            shortcutToActions[shortcut] = [];
          }
          shortcutToActions[shortcut].push(action);
        }
      }

      // 查找冲突
      for (const [shortcut, actions] of Object.entries(shortcutToActions)) {
        if (actions.length > 1) {
          for (const action of actions) {
            conflicts[action] = actions.filter(a => a !== action);
          }
        }
      }

      return conflicts;
    }

    /**
     * 获取冲突提示文本
     */
    function getConflictTooltipText(action) {
      const conflicts = detectShortcutConflicts();
      const conflictingActions = conflicts[action];

      if (!conflictingActions || conflictingActions.length === 0) {
        return null;
      }

      const conflictNames = conflictingActions.map(conflictAction => getActionName(conflictAction));
      return `Shortcut conflict with: ${conflictNames.join(', ')}`;
    }

    /**
     * 平台检测
     */
    function detectPlatform() {
      const userAgent = navigator.userAgent.toLowerCase();
      if (userAgent.includes('mac')) {
        platform = 'mac';
      } else if (userAgent.includes('win')) {
        platform = 'windows';
      } else {
        platform = 'linux';
      }
      document.body.className = `platform-${platform}`;
    }

    // ========== 渲染函数 ==========
    /**
     * 渲染快捷键列表（主页面）
     */
    function renderShortcutsList() {
      const hasShortcuts = Object.keys(shortcuts).length > 0;

      if (!hasShortcuts) {
        shortcutsList.innerHTML = `
          <div class="empty-state">
            <h2>No shortcuts configured yet</h2>
            <button class="button" id="configureBtn" style="margin-top: 16px;">Configure Shortcuts</button>
          </div>
        `;
        return;
      }

      const conflicts = detectShortcutConflicts();
      let html = '';

      html += `<div class="shortcuts-list-header">
        <p class="section-title">Shortcuts</p>
        <button class="iconBtnSmall" id="configureBtn">
          <svg width="24" height="24" fill="none" viewBox="0 0 24 24">
            <path fill="#000" d="M8.5 18a.5.5 0 0 0 .5-.5v-1.55a2.5 2.5 0 0 0 0-4.9V6.5a.5.5 0 0 0-1 0v4.55a2.501 2.501 0 0 0 0 4.9v1.55a.5.5 0 0 0 .5.5m7 0a.5.5 0 0 0 .5-.5v-4.55a2.501 2.501 0 0 0 0-4.9V6.5a.5.5 0 0 0-1 0v1.55a2.5 2.5 0 0 0 0 4.9v4.55a.5.5 0 0 0 .5.5m0-6a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m-7 3a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"></path>
          </svg>
        </button>
      </div>`;

      // 反转快捷键列表，让新增的显示在最上面
      const shortcutEntries = Object.entries(shortcuts).reverse();
      
      for (const [action, shortcut] of shortcutEntries) {
        const actionName = getActionName(action);
        const isCustom = isCustomAction(action);
        const hasConflict = conflicts[action] && conflicts[action].length > 0;
        const tooltipText = hasConflict ? getConflictTooltipText(action) : '';

        html += createShortcutCard({
          actionId: action,
          actionName: actionName,
          shortcut: shortcut,
          isCustomAction: isCustom,
          hasConflict: hasConflict,
          tooltipText: tooltipText,
          onCardClick: true, // 主页面允许点击执行
          allowCommandClick: true,
          allowSetShortcut: false // 主页面不显示设置按钮
        });
      }

      shortcutsList.innerHTML = html;
    }

    /**
     * 渲染配置列表（配置页面）
     */
    function renderConfigList() {
      const conflicts = detectShortcutConflicts();

      // 渲染默认动作
      let defaultHtml = '';
      const categories = Object.keys(defaultActions);

      categories.forEach(category => {
        defaultHtml += `<h3 class="category-title">${category}</h3>`;

        const actionsInCategory = Object.entries(defaultActions[category]);

        actionsInCategory.forEach(([action, name]) => {
          const shortcut = shortcuts[action] || '';
          const hasConflict = conflicts[action] && conflicts[action].length > 0;
          const tooltipText = hasConflict ? getConflictTooltipText(action) : '';

          defaultHtml += createShortcutCard({
            actionId: action,
            actionName: name,
            shortcut: shortcut,
            isCustomAction: false,
            hasConflict: hasConflict,
            tooltipText: tooltipText,
            onCardClick: null, // 配置页面不允许点击执行
            allowCommandClick: true,
            allowSetShortcut: true
          });
        });
      });

      document.getElementById('defaultConfigList').innerHTML = defaultHtml;

      // 渲染自定义动作
      let customHtml = '';
      customActions.forEach(action => {
        const shortcut = shortcuts[action.id] || '';
        const hasConflict = conflicts[action.id] && conflicts[action.id].length > 0;
        const tooltipText = hasConflict ? getConflictTooltipText(action.id) : '';

        customHtml += createShortcutCard({
          actionId: action.id,
          actionName: action.name,
          shortcut: shortcut,
          isCustomAction: true,
          hasConflict: hasConflict,
          tooltipText: tooltipText,
          onCardClick: () => editCustomAction(action.id), // 自定义动作点击编辑
          allowCommandClick: true,
          allowSetShortcut: true
        });
      });

      document.getElementById('customConfigList').innerHTML = customHtml;
    }

    // ========== 页面管理 ==========
    /**
     * 显示页面
     */
    function showPage(pageName) {
      pages.forEach(page => page.classList.remove('active'));

      switch (pageName) {
        case 'main':
          document.getElementById('mainPage').classList.add('active');
          currentPage = 'main';
          statusBarContainer.classList.remove('hidden');
          updateStatusBar('wait-action', 'Capturing Keys<span class="dots-animation"></span>', 'Press shortcuts to run actions • ⌘+Click to configure');
          renderShortcutsList();
          break;
        case 'config':
          document.getElementById('configPage').classList.add('active');
          currentPage = 'config';
          // 只有在非监听状态时才隐藏statusbar
          if (!isListening) {
            statusBarContainer.classList.add('hidden');
          }
          renderConfigList();
          break;
        case 'addCustom':
          document.getElementById('addCustomPage').classList.add('active');
          currentPage = 'addCustom';
          statusBarContainer.classList.add('hidden');

          if (!currentEditingActionId) {
            clearCustomForm();
            clearTempShortcuts(); // 清理临时快捷键
            const customId = 'custom_' + Date.now();
            const customShortcutContainer = document.getElementById('customShortcutBtn');
            customShortcutContainer.innerHTML = createSetShortcutButton({
              actionId: customId,
              shortcut: '',
              allowSetShortcut: true
            });
          }
          updateCustomFormActions();
          break;
      }

      setTimeout(() => {
        const searchContent = document.querySelector('.search-content');
        if (
          pageName === 'main' &&
          !isListening &&
          !searchContent.classList.contains('active')
        ) {
          focusable.focus();
        }
      }, 100);
    }

    /**
     * 切换标签
     */
    function switchTab(tabName) {
      tabs.forEach(tab => tab.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));

      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(`${tabName}Tab`).classList.add('active');

      currentTab = tabName;
    }

    // ========== 5. 快捷键业务逻辑 ==========
    /**
     * 处理按键按下
     */
    function handleKeyDown(event) {
      const key = event.key.toLowerCase();
      const code = event.code;

      // 在 addCustom 页面且不在监听状态时，允许表单输入
      if (currentPage === 'addCustom' && !isListening) {
        return;
      }

      // 监听状态处理
      if (isListening) {
        // ESC 取消
        if (key === 'escape') {
          event.preventDefault();
          cancelSetShortcut();
          return;
        }

        // DELETE 删除快捷键
        if (key === 'delete' || key === 'backspace') {
          event.preventDefault();
          deleteShortcut();
          return;
        }

        event.preventDefault();
        console.log('KeyDown:', code, 'metaKey:', event.metaKey, 'currentlyPressed before:', Array.from(currentlyPressed));

        // 清除延迟计时器
        if (delayTimer) {
          clearTimeout(delayTimer);
          delayTimer = null;
        }

        // 添加修饰键到两个集合
        if (event.metaKey) {
          pressedCodes.add('cmd');
          currentlyPressed.add('cmd');
        }
        if (event.ctrlKey) {
          pressedCodes.add('ctrl');
          currentlyPressed.add('ctrl');
        }
        if (event.altKey) {
          pressedCodes.add('alt');
          currentlyPressed.add('alt');
        }
        if (event.shiftKey) {
          pressedCodes.add('shift');
          currentlyPressed.add('shift');
        }

        // 添加主键（非修饰键）
        const modifierCodes = ['MetaLeft', 'MetaRight', 'ControlLeft', 'ControlRight', 'AltLeft', 'AltRight', 'ShiftLeft', 'ShiftRight'];
        if (!modifierCodes.includes(code)) {
          pressedCodes.add(code); // 累积显示
          currentlyPressed.add(code); // 当前按下
        }

        console.log('KeyDown currentlyPressed after:', Array.from(currentlyPressed));

        // 实时更新状态栏显示（显示所有按过的键）
        updateListeningStatusBar();

        // 检查是否有非修饰键
        const allCodes = Array.from(pressedCodes);
        const nonModifierCodes = allCodes.filter(c => !['cmd', 'ctrl', 'alt', 'shift'].includes(c));
        const modifierCodes_check = allCodes.filter(c => ['cmd', 'ctrl', 'alt', 'shift'].includes(c));

        if (nonModifierCodes.length > 0) {
          if (nonModifierCodes.length === 1) {
            // 有一个主键，立即保存（无论是否有修饰键）
            captureShortcut();
          } else {
            // 多个主键，无效组合
            // 不做处理，等待用户操作
          }
        }
      }
      // 其他页面的 ESC 处理
      else if (key === 'escape') {
        event.preventDefault();
        if (currentPage === 'main') {
          parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*');
        } else if (currentPage === 'config') {
          showPage('main');
        } else if (currentPage === 'addCustom') {
          showPage('config');
        }
      }
      // 主页面快捷键执行
      else if (currentPage === 'main') {
        const shortcut = getShortcutFromEvent(event);
        executeShortcut(shortcut);
      }
    }

    /**
     * 处理按键松开
     */
    function handleKeyUp(event) {
      const code = event.code;

      if (currentPage === 'addCustom' && !isListening) {
        return;
      }

      if (isListening) {
        // 忽略第一个keyup（command点击触发时）
        if (ignoreFirstKeyUp) {
          ignoreFirstKeyUp = false;
          console.log('Ignored first keyup:', code);
          return;
        }

        event.preventDefault();
        console.log('KeyUp:', code, 'metaKey:', event.metaKey, 'currentlyPressed before:', Array.from(currentlyPressed));

        // 从当前按下的集合中移除键
        currentlyPressed.delete(code);
        if (!event.metaKey) currentlyPressed.delete('cmd');
        if (!event.ctrlKey) currentlyPressed.delete('ctrl');
        if (!event.altKey) currentlyPressed.delete('alt');
        if (!event.shiftKey) currentlyPressed.delete('shift');

        console.log('currentlyPressed after:', Array.from(currentlyPressed));

        // 检查是否需要清理状态或退出监听
        if (currentlyPressed.size === 0) {
          console.log('All keys released, checking exit condition. pressedCodes:', Array.from(pressedCodes), 'shortcutSaved:', shortcutSaved);
          if (currentlyPressed.size === 0 && isListening) {
            // 检查是否只按过修饰键
            const allPressedCodes = Array.from(pressedCodes);
            const modifierKeys = ['cmd', 'ctrl', 'alt', 'shift'];
            const hasOnlyModifiers = allPressedCodes.length > 0 && allPressedCodes.every(k => modifierKeys.includes(k));

            console.log('hasOnlyModifiers:', hasOnlyModifiers, 'shortcutSaved:', shortcutSaved);

            if (hasOnlyModifiers && !shortcutSaved) {
              // 只按过修饰键且未保存快捷键，清空并继续监听
              console.log('Continue listening - only modifiers');
              pressedCodes.clear();
              updateListeningStatusBar();
            } else {
              // 有主键、已保存快捷键或没按任何键，退出监听
              console.log('Exit listening - has main key or saved shortcut');
              stopSetShortcut();
            }
          }
        } else if (shortcutSaved) {
          // 特殊情况：已保存快捷键但还有键显示为按下（可能是 keyup 事件丢失）
          // 检查当前实际的修饰键状态
          const actualModifiers = [];
          if (event.metaKey) actualModifiers.push('cmd');
          if (event.ctrlKey) actualModifiers.push('ctrl');
          if (event.altKey) actualModifiers.push('alt');
          if (event.shiftKey) actualModifiers.push('shift');

          console.log('Checking for lost keyup events. actualModifiers:', actualModifiers, 'currentlyPressed:', Array.from(currentlyPressed));

          // 如果实际修饰键状态显示没有键按下，但 currentlyPressed 不为空
          if (actualModifiers.length === 0 && currentlyPressed.size > 0) {
            console.log('Detected lost keyup events, force clearing currentlyPressed');
            currentlyPressed.clear();
            // 重新检查退出条件
            if (currentlyPressed.size === 0 && isListening) {
              console.log('Force exit after clearing lost keys');
              stopSetShortcut();
            }
          }
        }
      }
    }

    /**
     * 更新监听状态下的状态栏显示
     */
    function updateListeningStatusBar() {
      if (!isListening) return;

      const keys = Array.from(pressedCodes);
      let keysDisplay = '';

      if (keys.length > 0) {
        // 对键进行排序，修饰键在前，主键在后
        const modifierOrder = ['cmd', 'ctrl', 'alt', 'shift'];
        const modifiers = keys.filter(k => modifierOrder.includes(k)).sort((a, b) => modifierOrder.indexOf(a) - modifierOrder.indexOf(b));
        const mainKeys = keys.filter(k => !modifierOrder.includes(k));

        const sortedKeys = [...modifiers, ...mainKeys];
        keysDisplay = sortedKeys.map(key => codeToDisplayKey(key)).join(' + ');
      }

      const actionName = getActionName(listeningActionId);
      const isFloat = currentPage === 'config' || currentPage === 'addCustom';

      if (keysDisplay) {
        updateStatusBar('listening-set', keysDisplay, 'Press more keys or release to set shortcut', isFloat);
      } else {
        updateStatusBar('listening-set', `Press keys to set shortcut<span class="dots-animation"></span>`, 'ESC to cancel • DELETE to remove', isFloat);
      }

      // 确保在config页面和自定义页面时添加float样式
      if (isFloat) {
        statusBar.classList.add('float');
      }
    }

    /**
     * 捕获快捷键
     */
    function captureShortcut() {
      if (!isListening || !listeningActionId || pressedCodes.size === 0) return;

      const keys = Array.from(pressedCodes);
      const modifierKeys = ['cmd', 'ctrl', 'alt', 'shift'];
      const modifiers = keys.filter(k => modifierKeys.includes(k));
      const mainKeys = keys.filter(k => !modifierKeys.includes(k));

      // 验证快捷键规则
      if (mainKeys.length === 0) {
        // 只有修饰键，无效
        const actionName = getActionName(listeningActionId);
        const isFloat = currentPage === 'config' || currentPage === 'addCustom';
        updateStatusBar('listening-set', `Invalid shortcut`, 'Need at least one main key • ESC to cancel • DELETE to remove', isFloat);

        // 确保在config页面和自定义页面时添加float样式
        if (isFloat) {
          statusBar.classList.add('float');
        }

        return;
      }

      if (mainKeys.length > 1) {
        // 多个主键，无效
        const actionName = getActionName(listeningActionId);
        const isFloat = currentPage === 'config' || currentPage === 'addCustom';
        updateStatusBar('listening-set', `Invalid shortcut`, 'Only one main key allowed • ESC to cancel • DELETE to remove', isFloat);

        // 确保在config页面和自定义页面时添加float样式
        if (isFloat) {
          statusBar.classList.add('float');
        }

        return;
      }

      // 构建快捷键字符串，修饰键在前，主键在后
      const modifierOrder = ['cmd', 'ctrl', 'alt', 'shift'];
      const sortedModifiers = modifiers.sort((a, b) => modifierOrder.indexOf(a) - modifierOrder.indexOf(b));
      const shortcutKeys = [...sortedModifiers, ...mainKeys];
      const shortcut = shortcutKeys.join('+');

      // 保存快捷键
      if (currentPage === 'addCustom') {
        // 在自定义动作页面，只临时保存
        tempShortcuts[listeningActionId] = shortcut;
      } else {
        // 在其他页面，立即保存
        shortcuts[listeningActionId] = shortcut;
        saveData();
        
        // 只在非自定义动作页面发送成功通知
        const actionName = getActionName(listeningActionId);
        parent.postMessage({
          pluginMessage: {
            type: 'shortcut-set-success',
            actionName: actionName
          }
        }, '*');
      }

      // 更新UI - 只更新对应的快捷键按钮，不重新渲染整个列表
      updateShortcutButton(listeningActionId);

      // 标记已保存，但不立即停止监听
      shortcutSaved = true;
    }

    /**
     * 取消设置快捷键
     */
    function cancelSetShortcut() {
      if (!isListening) return;

      // 清空所有按键和重置状态
      shortcutSaved = false;
      pressedCodes.clear();
      currentlyPressed.clear();

      stopSetShortcut();
    }

    /**
     * 删除快捷键
     */
    function deleteShortcut() {
      if (!isListening || !listeningActionId) return;

      const actionId = listeningActionId;
      const actionName = getActionName(actionId);

      if (currentPage === 'addCustom') {
        // 在自定义动作页面，删除临时快捷键
        delete tempShortcuts[actionId];
      } else {
        // 在其他页面，删除正式快捷键
        delete shortcuts[actionId];
        saveData();
      }

      // 清空所有按键和重置状态
      shortcutSaved = false;
      pressedCodes.clear();
      currentlyPressed.clear();

      // 更新UI
      if (currentPage === 'main') {
        // 在主页面需要重新渲染整个列表，因为删除快捷键可能导致列表结构变化
        setTimeout(() => {
          renderShortcutsList();
        }, 20);
      } else {
        // 在其他页面只更新对应的快捷键按钮
        updateShortcutButton(actionId);
      }

      const isFloat = currentPage === 'config' || currentPage === 'addCustom';
      updateStatusBar('listening-set', `Shortcut removed`, 'Shortcut removed successfully', isFloat);

      // 确保在config页面和自定义页面时添加float样式
      if (isFloat) {
        statusBar.classList.add('float');
      }

      setTimeout(() => {
        stopSetShortcut();
      }, 1000);
    }

    /**
     * 从事件获取快捷键
     */
    function getShortcutFromEvent(event) {
      const keys = [];

      if (event.metaKey) keys.push('cmd');
      if (event.ctrlKey) keys.push('ctrl');
      if (event.altKey) keys.push('alt');
      if (event.shiftKey) keys.push('shift');

      const code = event.code;
      const modifierCodes = ['MetaLeft', 'MetaRight', 'ControlLeft', 'ControlRight', 'AltLeft', 'AltRight', 'ShiftLeft', 'ShiftRight'];
      if (!modifierCodes.includes(code)) {
        keys.push(code);
      }

      return keys.length > 0 ? keys.join('+') : null;
    }

    /**
     * 执行快捷键
     */
    function executeShortcut(shortcut) {
      for (const [action, actionShortcut] of Object.entries(shortcuts)) {
        if (actionShortcut === shortcut) {
          updateStatusBar('wait-action', `Executing: ${getActionName(action)}`, '');

          parent.postMessage({
            pluginMessage: {
              type: 'shortcut-triggered',
              action: action
            }
          }, '*');

          setTimeout(() => {
            updateStatusBar('wait-action', 'Capturing Keys<span class="dots-animation"></span>', 'Press shortcuts to run actions • ⌘+Click to configure');
          }, 1000);

          return;
        }
      }
    }

    // ========== 数据管理 ==========
    function loadData() {
      parent.postMessage({
        pluginMessage: {
          type: 'load-data'
        }
      }, '*');
    }

    function saveData() {
      parent.postMessage({
        pluginMessage: {
          type: 'save-data',
          shortcuts: shortcuts,
          customActions: customActions
        }
      }, '*');
    }

    // ========== 自定义动作管理 ==========
    function clearCustomForm() {
      document.getElementById('customActionName').value = '';
      document.getElementById('customActionFunction').value = '';

      const headerTitle = document.querySelector('#addCustomPage h2');
      if (headerTitle) {
        headerTitle.textContent = 'Add Custom Action';
      }

      currentEditingActionId = null;
    }

    function clearTempShortcuts() {
      tempShortcuts = {};
    }

    /**
     * 更新指定动作的快捷键按钮显示
     * @param {string} actionId - 动作 ID
     */
    /**
     * 更新单个快捷键按钮
     */
    function updateSingleShortcutButton(button, actionId) {
      // 如果当前正在监听这个按钮，不要覆盖监听状态
      if (isListening && listeningActionId === actionId) {
        return;
      }

      const currentShortcut = getShortcut(actionId);
      const hasShortcut = currentShortcut && currentShortcut.length > 0;
      const isMainPage = currentPage === 'main';
      
      // 更新按钮状态类
      button.className = `shortcut-button ${hasShortcut ? 'state-set' : 'state-empty'} clickable ${isMainPage ? 'disabled' : ''}`;
      
      // 更新按钮文本
      const actionBtn = button.querySelector('.action-button');
      if (actionBtn) {
        actionBtn.textContent = 'Set Shortcut';
        actionBtn.classList.remove('listening');
      }
      
      // 更新按键显示
      const keyDisplay = button.querySelector('.key-display');
      if (keyDisplay) {
        if (hasShortcut) {
          keyDisplay.innerHTML = renderShortcutKeys(currentShortcut);
        } else {
          keyDisplay.innerHTML = '';
        }
      }
    }

    function updateShortcutButton(actionId) {
      // 查找所有页面中对应的快捷键按钮
      const buttons = document.querySelectorAll(`[data-action="${actionId}"] .shortcut-button`);
      buttons.forEach(button => updateSingleShortcutButton(button, actionId));

      // 特别处理自定义动作页面中的快捷键按钮
      if (currentPage === 'addCustom') {
        const customShortcutButton = document.querySelector('#customShortcutBtn .shortcut-button');
        if (customShortcutButton && customShortcutButton.dataset.action === actionId) {
          updateSingleShortcutButton(customShortcutButton, actionId);
        }
      }
    }

    function saveCustomAction(update = false) {
      const name = document.getElementById('customActionName').value.trim();
      const functionCode = document.getElementById('customActionFunction').value.trim();

      if (!name || !functionCode) {
        alert('Please fill in all fields');
        return;
      }

      if (functionCode.includes('postMessage')) {
        alert('Security violation: postMessage is not allowed in custom actions');
        return;
      }

      let action;
      let actionId;

      if (currentEditingActionId) {
        actionId = currentEditingActionId;
        const existingActionIndex = customActions.findIndex(a => a.id === currentEditingActionId);
        if (existingActionIndex !== -1) {
          customActions[existingActionIndex] = {
            ...customActions[existingActionIndex],
            name: name,
            function: functionCode
          };
          action = customActions[existingActionIndex];
        }
      } else {
        const customShortcutButton = document.querySelector('#customShortcutBtn .shortcut-button');
        actionId = customShortcutButton ? customShortcutButton.dataset.action : 'custom_' + Date.now();
        action = { id: actionId, name, function: functionCode };
        customActions.push(action);
      }

      // 将临时快捷键保存到正式存储
      if (tempShortcuts[actionId]) {
        shortcuts[actionId] = tempShortcuts[actionId];
        delete tempShortcuts[actionId]; // 清理临时存储
      }

      saveData();

      parent.postMessage({
        pluginMessage: {
          type: 'custom-action-added',
          action: action,
          update: update
        }
      }, '*');

      renderShortcutsList();
      currentEditingActionId = null;
      clearTempShortcuts(); // 清理所有临时快捷键
      showPage('config');
    }

    function editCustomAction(actionId) {
      const action = customActions.find(a => a.id === actionId);
      if (!action) return;

      currentEditingActionId = actionId;
      showPage('addCustom');

      setTimeout(() => {
        document.getElementById('customActionName').value = action.name;
        document.getElementById('customActionFunction').value = action.function;

        const customShortcutContainer = document.getElementById('customShortcutBtn');
        const shortcut = getShortcut(actionId);
        customShortcutContainer.innerHTML = createSetShortcutButton({
          actionId: actionId,
          shortcut: shortcut,
          allowSetShortcut: true
        });

        const headerTitle = document.querySelector('#addCustomPage h2');
        if (headerTitle) {
          headerTitle.textContent = 'Edit Custom Action';
        }

        updateCustomFormActions();
      }, 10);
    }

    function deleteCustomAction() {
      if (!currentEditingActionId) return;

      if (confirm('Are you sure you want to delete this custom action?')) {
        const actionIndex = customActions.findIndex(a => a.id === currentEditingActionId);
        if (actionIndex !== -1) {
          customActions.splice(actionIndex, 1);
        }

        if (shortcuts[currentEditingActionId]) {
          delete shortcuts[currentEditingActionId];
        }

        // 清理临时快捷键
        if (tempShortcuts[currentEditingActionId]) {
          delete tempShortcuts[currentEditingActionId];
        }

        saveData();
        renderShortcutsList();
        renderConfigList();
        currentEditingActionId = null;
        clearTempShortcuts(); // 清理所有临时快捷键
        showPage('config');
      }
    }

    function updateCustomFormActions() {
      const saveBtn = document.getElementById('saveCustomBtn');
      const moreGroup = document.querySelector('.more-action-button-group');
      if (currentEditingActionId) {
        saveBtn.style.display = 'none';
        moreGroup.style.display = 'flex';
      } else {
        saveBtn.style.display = 'inline-block';
        moreGroup.style.display = 'none';
      }
    }

    function testRunCustomAction() {
      const functionCode = document.getElementById('customActionFunction').value.trim();
      
      if (!functionCode) {
        alert('Please enter function code first');
        return;
      }

      if (functionCode.includes('postMessage')) {
        alert('Security violation: postMessage is not allowed in custom actions');
        return;
      }

      // Send test run request to plugin
      parent.postMessage({
        pluginMessage: {
          type: 'test-run-custom-action',
          functionCode: functionCode
        }
      }, '*');
    }

    // ========== 搜索功能 ==========
    function toggleSearch() {
      const tabsContent = document.querySelector('.tabs-content');
      const searchContent = document.querySelector('.search-content');
      const searchInput = document.getElementById('searchInput');

      if (searchContent.classList.contains('active')) {
        searchContent.classList.remove('active');
        tabsContent.style.display = 'flex';
        searchInput.value = '';
        renderConfigList();
      } else {
        searchContent.classList.add('active');
        tabsContent.style.display = 'none';
        searchInput.focus();
      }
    }

    function handleSearchInput(event) {
      const searchTerm = event.target.value.toLowerCase().trim();

      if (searchTerm === '') {
        renderConfigList();
        return;
      }

      const conflicts = detectShortcutConflicts();

      // 过滤默认动作
      let defaultHtml = '';
      let foundResults = false;

      for (const [category, actions] of Object.entries(defaultActions)) {
        let categoryHtml = '';
        let categoryHasResults = false;

        for (const [action, name] of Object.entries(actions)) {
          if (name.toLowerCase().includes(searchTerm)) {
            const shortcut = shortcuts[action] || '';
            const hasConflict = conflicts[action] && conflicts[action].length > 0;
            const tooltipText = hasConflict ? getConflictTooltipText(action) : '';

            categoryHtml += createShortcutCard({
              actionId: action,
              actionName: name,
              shortcut: shortcut,
              isCustomAction: false,
              hasConflict: hasConflict,
              tooltipText: tooltipText,
              onCardClick: null,
              allowCommandClick: true,
              allowSetShortcut: true
            });

            categoryHasResults = true;
            foundResults = true;
          }
        }

        if (categoryHasResults) {
          defaultHtml += `<h3 class="category-title">${category}</h3>`;
          defaultHtml += categoryHtml;
        }
      }

      if (!foundResults) {
        defaultHtml = '<div class="empty-search-state">No results</div>';
      }

      // 过滤自定义动作
      let customHtml = '';
      customActions.forEach(action => {
        if (action.name.toLowerCase().includes(searchTerm)) {
          const shortcut = shortcuts[action.id] || '';
          const hasConflict = conflicts[action.id] && conflicts[action.id].length > 0;
          const tooltipText = hasConflict ? getConflictTooltipText(action.id) : '';

          customHtml += createShortcutCard({
            actionId: action.id,
            actionName: action.name,
            shortcut: shortcut,
            isCustomAction: true,
            hasConflict: hasConflict,
            tooltipText: tooltipText,
            onCardClick: () => editCustomAction(action.id),
            allowCommandClick: true,
            allowSetShortcut: true
          });
        }
      });

      document.getElementById('defaultConfigList').innerHTML = defaultHtml;
      document.getElementById('customConfigList').innerHTML = customHtml;
    }

    // ========== 事件监听器设置 ==========
    function setupEventListeners() {
      // 页面导航
      backBtn.addEventListener('click', () => showPage('main'));
      backToConfigBtn.addEventListener('click', () => {
        clearTempShortcuts(); // 清理临时快捷键
        clearCustomForm();    // 清理表单和编辑状态
        showPage('config');
      });
      addCustomBtn.addEventListener('click', () => showPage('addCustom'));

      // 标签切换
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          switchTab(tabName);
        });
      });

      // 事件委托
      document.addEventListener('click', (e) => {
        // 设置快捷键按钮点击
        if (e.target.closest('.shortcut-button')) {
          const button = e.target.closest('.shortcut-button');
          const actionId = button.dataset.action;
          startSetShortcut(actionId, false);
        }
        // 配置按钮点击
        else if (e.target.id === 'configureBtn') {
          showPage('config');
        }
        // 快捷键卡片点击（主页面）
        else if (e.target.closest('.shortcut-card.clickable') && currentPage === 'main') {
          const card = e.target.closest('.shortcut-card');
          const actionId = card.dataset.action;

          if (e.metaKey || e.ctrlKey) {
            e.preventDefault();
            startSetShortcut(actionId, true);
          } else {
            const actionName = getActionName(actionId);
            updateStatusBar('wait-action', `Executing: ${actionName}`, '');

            parent.postMessage({
              pluginMessage: {
                type: 'shortcut-triggered',
                action: actionId
              }
            }, '*');

            setTimeout(() => {
              updateStatusBar('wait-action', 'Capturing Keys<span class="dots-animation"></span>', 'Press shortcuts to run actions • ⌘+Click to configure');
            }, 1000);
          }
        }
        // 命令点击（配置页面）
        else if (e.target.closest('.shortcut-card') && (e.metaKey || e.ctrlKey)) {
          e.preventDefault();
          const card = e.target.closest('.shortcut-card');
          const actionId = card.dataset.action;
          startSetShortcut(actionId, true);
        }
        // 自定义动作卡片点击（编辑）
        else if (e.target.closest('.shortcut-card.custom-action') &&
          !e.target.closest('.shortcut-button') &&
          currentPage === 'config') {
          const card = e.target.closest('.shortcut-card');
          const actionId = card.dataset.action;
          editCustomAction(actionId);
        }
      });

      // 搜索功能
      document.getElementById('searchBtn').addEventListener('click', toggleSearch);
      document.getElementById('closeSearchBtn').addEventListener('click', toggleSearch);
      document.getElementById('searchInput').addEventListener('input', handleSearchInput);

      // 表单输入焦点
      document.getElementById('searchInput').addEventListener('click', (e) => {
        e.stopPropagation();
        e.target.focus();
      });

      document.addEventListener('click', (e) => {
        if (e.target.closest('.search-input-container')) {
          e.preventDefault();
          e.stopPropagation();
          document.getElementById('searchInput').focus();
        }
      });

      // 自定义动作表单
      document.getElementById('saveCustomBtn').addEventListener('click', () => saveCustomAction(false));
      document.getElementById('saveCustomBtnGroup').addEventListener('click', () => saveCustomAction(true));
      document.getElementById('cancelCustomBtn').addEventListener('click', () => {
        clearTempShortcuts(); // 清理临时快捷键
        clearCustomForm();    // 清理表单和编辑状态
        showPage('config');
      });
      document.getElementById('testRunBtn').addEventListener('click', testRunCustomAction);

      document.getElementById('customActionName').addEventListener('click', (e) => {
        e.stopPropagation();
        e.target.focus();
      });

      document.getElementById('customActionFunction').addEventListener('click', (e) => {
        e.stopPropagation();
        e.target.focus();
      });

      // 键盘事件
      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('keyup', handleKeyUp);

      // 焦点管理
      document.addEventListener('click', (e) => {
        const searchContent = document.querySelector('.search-content');
        if (
          currentPage === 'main' &&
          !isListening &&
          !searchContent.classList.contains('active')
        ) {
          focusable.focus();
        }
      });

      window.addEventListener('blur', () => {
        setTimeout(() => {
          const searchContent = document.querySelector('.search-content');
          if (
            currentPage === 'main' &&
            !isListening &&
            !searchContent.classList.contains('active')
          ) {
            focusable.focus();
          }
        }, 10);
      });

      // 提示框功能
      let tooltip = null;
      let tooltipTimeout = null;

      function createTooltip() {
        if (tooltip) return tooltip;

        tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        document.body.appendChild(tooltip);
        return tooltip;
      }

      function showTooltip(element, text) {
        if (!text) return;

        const tooltipEl = createTooltip();
        tooltipEl.textContent = text;
        tooltipEl.classList.add('show');

        const rect = element.getBoundingClientRect();
        const tooltipRect = tooltipEl.getBoundingClientRect();

        let left = rect.left + rect.width / 2;
        if (left + tooltipRect.width / 2 > window.innerWidth) {
          left = window.innerWidth - tooltipRect.width / 2 - 10;
        } else if (left - tooltipRect.width / 2 < 0) {
          left = tooltipRect.width / 2 + 10;
        }

        tooltipEl.style.left = left + 'px';
        tooltipEl.style.top = (rect.top - tooltipRect.height - 8) + 'px';
      }

      function hideTooltip() {
        if (tooltip) {
          tooltip.classList.remove('show');
        }
        if (tooltipTimeout) {
          clearTimeout(tooltipTimeout);
          tooltipTimeout = null;
        }
      }

      document.addEventListener('mouseover', (e) => {
        const shortcutCard = e.target.closest('.shortcut-card.conflict');
        if (shortcutCard && shortcutCard.dataset.tooltip) {
          tooltipTimeout = setTimeout(() => {
            showTooltip(shortcutCard, shortcutCard.dataset.tooltip);
          }, 100);
        }
      });

      document.addEventListener('mouseout', (e) => {
        const shortcutCard = e.target.closest('.shortcut-card.conflict');
        if (shortcutCard) {
          hideTooltip();
        }
      });

      document.addEventListener('click', hideTooltip);
      document.addEventListener('keydown', hideTooltip);

      // 更多操作下拉菜单
      const moreActionsBtn = document.getElementById('moreActionsBtn');
      const moreActionsDropdown = document.getElementById('moreActionsDropdown');
      let dropdownOpen = false;

      if (moreActionsBtn) {
        moreActionsBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          dropdownOpen = !dropdownOpen;
          moreActionsDropdown.style.display = dropdownOpen ? 'block' : 'none';
          moreActionsBtn.classList.add('active');
        });

        document.addEventListener('click', function () {
          if (dropdownOpen) {
            moreActionsDropdown.style.display = 'none';
            dropdownOpen = false;
            moreActionsBtn.classList.remove('active');
          }
        });

        moreActionsDropdown.addEventListener('click', function (e) {
          e.stopPropagation();
        });
      }

      document.getElementById('duplicateCustomBtn').addEventListener('click', function () {
        if (!currentEditingActionId) return;
        const action = customActions.find(a => a.id === currentEditingActionId);
        if (!action) return;

        const newId = 'custom_' + Date.now();
        const newAction = { ...action, id: newId, name: action.name + ' Copy' };
        customActions.push(newAction);
        saveData();
        renderConfigList();
        showPage('config');
      });

      document.getElementById('deleteCustomBtn').addEventListener('click', function () {
        deleteCustomAction();
      });
    }

    // ========== 初始化 ==========
    function init() {
      detectPlatform();
      loadData();
      setupEventListeners();
      focusable.focus();
    }

    // ========== 消息处理 ==========
    window.addEventListener('message', (event) => {
      if (event.data.pluginMessage) {
        const msg = event.data.pluginMessage;
        if (msg.type === 'shortcut-result') {
          if (currentPage === 'main') {
            updateStatusBar('wait-action', msg.message, '');
            setTimeout(() => {
              updateStatusBar('wait-action', 'Capturing Keys<span class="dots-animation"></span>', 'Press shortcuts to run actions • ⌘+Click to configure');
            }, 1000);
          }
        } else if (msg.type === 'data-loaded') {
          shortcuts = msg.shortcuts || {};
          customActions = msg.customActions || [];
          defaultActions = msg.defaultActions || {};
          renderShortcutsList();
          renderConfigList();
        } else if (msg.type === 'test-run-result') {
        }
      }
    });

    // 启动应用
    init();
  </script>
</body>

</html>